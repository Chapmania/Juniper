<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        textarea {
            width: 800px;
            height: 300px;
        }
    </style>
</head>
<body>
    <p>
        <input id="username" type="text" />
        <input id="password" type="password" />
        <button id="login">Login</button>
        <button id="logout" disabled>Logout</button>
    </p>

    <p>
        <button id="connect" disabled>Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
        <span id="status">none</span>
    </p>

    <p>
        <input id="input" type="text" disabled />
        <button id="send" disabled>Send</button>
    </p>

    <p>
        <textarea id="output" readonly></textarea>
    </p>

    <script type="text/javascript">
        var socket = null;
        var usernameText = document.getElementById("username");
        var passwordText = document.getElementById("password");
        var loginButton = document.getElementById("login");
        var logoutButton = document.getElementById("logout");
        var connectButton = document.getElementById("connect");
        var disconnectButton = document.getElementById("disconnect");
        var sendButton = document.getElementById("send");
        var inputText = document.getElementById("input");
        var statusText = document.getElementById("status");
        var outputText = document.getElementById("output");
        var token = null;

        function login() {
            loginButton.disabled = true;
            usernameText.disabled = true;
            passwordText.disabled = true;
            var authPair = usernameText.value + ":" + passwordText.value;
            var authHash = btoa(authPair);
            fetch("http://localhost:8080/auth/", {
                method: "POST",
                headers: {
                    Authorization: "Basic " + authHash
                }
            }).then(function (response) {
                switch (response.status) {
                    case 200:
                        logoutButton.disabled = false;
                        connectButton.disabled = false;
                        inputText.focus();
                        response.text().then(function (t) {
                            console.log(t);
                            token = t;
                        });
                        break;
                    default:
                        loginButton.disabled = false;
                        usernameText.disabled = false;
                        passwordText.disabled = false;
                        connectButton.disabled = true;
                        inputText.disabled = true;
                        usernameText.focus();
                        break;
                }
            });
        }

        function logout() {
            token = null;
            if (socket !== null) {
                disconnect();
            }
            logoutButton.disabled = true;
            loginButton.disabled = false;
            usernameText.disabled = false;
            passwordText.disabled = false;
            usernameText.value = "";
            passwordText.value = "";
            usernameText.focus();
        }

        function status(msg) {
            if (msg) {
                console.log(msg);
            }

            var sockStatus;
            switch (socket && socket.readyState) {
                case WebSocket.OPEN: sockStatus = "open"; break;
                case WebSocket.CONNECTING: sockStatus = "connecting"; break;
                case WebSocket.CLOSING: sockStatus = "closing"; break;
                case WebSocket.CLOSED: sockStatus = "closed"; break;
                default: sockStatus = "unknown"; break;
            }

            connectButton.disabled = sockStatus === "open" || sockStatus === "connecting" || token === null;
            disconnectButton.disabled = sockStatus == "connecting" || sockStatus == "closing" || sockStatus == "closed" || sockStatus == "unknown";
            inputText.disabled = sendButton.disabled = sockStatus != "open";

            statusText.innerHTML = sockStatus;
        }

        function input() {
            socket.send(inputText.value);
            inputText.value = "";
            inputText.focus();
        }

        function output(msg) {
            outputText.value = msg + "\n" + outputText.value;
        }

        function onenter(textBox, func) {
            return function (evt) {
                if (textBox.value.length > 0 && evt.keyCode === 13) {
                    func(evt);
                }
            }
        }

        function disconnect() {
            connectButton.disabled = false;
            status("Disconnecting");
            socket.close();
        }

        usernameText.addEventListener("keydown", onenter(usernameText, passwordText.focus.bind(passwordText)));
        passwordText.addEventListener("keydown", onenter(passwordText, login));
        loginButton.addEventListener("click", login);
        logoutButton.addEventListener("click", logout);
        sendButton.addEventListener("click", input);
        inputText.addEventListener("keydown", onenter(inputText, input));

        connectButton.addEventListener("click", function () {
            status("Connecting");
            socket = new WebSocket("ws://localhost:8080/connect/", [token]);

            socket.addEventListener("open", function (evt) {
                status("Open");
            });

            socket.addEventListener("close", function (evt) {
                status("Close");
                socket = null;
            });

            socket.addEventListener("error", function (evt) {
                status("Error");
            });

            socket.addEventListener("message", function (evt) {
                output(evt.data);
                status();
            });
        });

        disconnectButton.addEventListener("click", disconnect);

        status();
    </script>
</body>
</html>